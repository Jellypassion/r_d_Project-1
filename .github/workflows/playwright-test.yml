name: Playwright CI Tests
on:
  push:
    branches: [ main, master, lesson-22 ]
  pull_request:
    branches: [ main ]
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: 'Lesson_22'
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 24.x
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium
    - name: Run Playwright tests
      run: npm run test

    - name: Debug - show files
      run: |
        echo "PWD: $(pwd)"
        echo "Workspace root content:"
        ls -la
        echo "Tree (3 levels):"
        find . -maxdepth 3 -type d -print
        echo "Playwright report dir listing (if present):"
        ls -la playwright-report || true
        echo "Allure results dir listing (if present):"
        ls -la allure-results || true
        echo "Allure report dir listing (if present):"
        ls -la allure-report || true

    - name: Upload Playwright blob report
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: blob-report
        path: ./blob-report/**
        if-no-files-found: warn
        retention-days: 30

    - name: Debug - blob-report contents
      run: |
        echo "Listing ./blob-report contents (pwd=$(pwd))"
        ls -la ./blob-report || echo "./blob-report not found"

    - name: Generate Allure HTML report
      run: |
        npx allure generate allure-results -o allure-report || echo "No results to generate"

    - name: Debug - allure-report contents
      run: |
        echo "Listing ./allure-report contents (pwd=$(pwd))"
        ls -la ./allure-report || echo "./allure-report not found"

    - name: Upload Allure HTML report
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: ./allure-report/**
        if-no-files-found: warn
